<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
	<title>Decipher Dash - UPDATED</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
	
	<!-- Made with Construct, the game and app creator :: https://www.construct.net -->
	<meta name="generator" content="Scirra Construct">

	<meta name="author" content="Viridino Studios">

	<link rel="manifest" href="appmanifest.json">
	<link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
	<link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
	<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
	<link rel="icon" type="image/png" href="icons/icon-512.png">

	<link rel="stylesheet" href="style.css?v=20">
	<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">



</head> 
 
<body>

	<div id="game-menu">
		<div id="menu-poster"></div>
		<button id="play-btn">PLAY</button>
		<button id="about-btn">ABOUT</button>
		<button id="setting-btn">SETTING</button>
		
		<div id="loading-screen" style="display: none;">
			<img src="images/loading.gif" alt="Loading...">
		</div>

		<div id="spaceship-screen" style="display: none;">
			<video id="outro-video" muted playsinline>
				<source src="images/outro.mp4" type="video/mp4">
			</video>
		</div>
        <div id="skip-container" style="display: none;">
            <div class="skip-icon">S</div>
            <div class="skip-text">Skip</div>
        </div>
	</div>

		<!-- In-Game Setting Icon -->
		<div id="ingame-setting-icon" style="display: none;">
			<img src="icons/setting%20icon%202.png" alt="Settings">
		</div>

		<!-- Player Hearts (Lives) -->
		<div id="player-hearts" style="display: none;">
			<img src="icons/heart%202.png" class="heart-icon" id="heart-1">
			<img src="icons/heart%202.png" class="heart-icon" id="heart-2">
			<img src="icons/heart%202.png" class="heart-icon" id="heart-3">
		</div>
		<div id="gem-counter" style="display: none;">0</div>

		<!-- Menu Music -->
		<audio id="menu-music" loop>
			<source src="Musics/menu music.mp3" type="audio/mpeg">
		</audio>

		<!-- Level 1 Music -->
		<audio id="level1-music" loop>
			<source src="Musics/level1.mp3" type="audio/mpeg">
		</audio>

		<!-- Intro Sound -->
		<audio id="intro-sound">
			<source src="Soundfx/playstation-3-start-61205.mp3" type="audio/mpeg">
		</audio>

		<!-- Button Click Sound -->
		<audio id="click-sound">
			<source src="Soundfx/mouse-click-117076.mp3" type="audio/mpeg">
		</audio>

		<!-- Pixel Death Sound -->
		<audio id="pixel-death-sound">
			<source src="Soundfx/pixel-death-66829.mp3" type="audio/mpeg">
		</audio>

		<!-- Get Coin Sound -->
		<audio id="get-coin-sound">
			<source src="Soundfx/get-coin-351945.mp3" type="audio/mpeg">
		</audio>

		<!-- Game Over Sound -->
		<audio id="game-over-sound">
			<source src="Soundfx/game-over-417465.mp3" type="audio/mpeg">
		</audio>
		<!-- Level Passed Sound -->
		<audio id="level-passed-sound">
			<source src="Soundfx/level-passed-143039.mp3" type="audio/mpeg">
		</audio>

		<!-- Game Over Screen -->
		<div id="game-over-screen" style="display: none;">
			<img src="icons/You_Died.png" alt="You Died">
			<div id="game-over-countdown"></div>
			<button id="game-over-back-btn">BACK TO MENU</button>
		</div>
		<div id="you-win-screen" style="display: none;">
			<img src="icons/win.png" alt="You Win" class="win-icon">
			<img src="icons/cup.png" alt="Cup" class="cup-icon">
			<div id="win-score-text">Your Highest Scores: 0</div>
			<button id="you-win-back-btn">BACK TO MENU</button>
		</div>

		<div id="setting-modal" class="modal" style="display: none;">
			<div class="modal-content">
				<span class="close-btn setting-close">&times;</span>
				<div class="setting-wrapper">
					<img src="images/setting UX.jpg" alt="Settings">
					<div class="setting-content">
						<div class="volume-control">
							<label for="volume-slider">MUSIC VOLUME</label>
							<input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
						</div>
						<div class="volume-control">
							<label for="sfx-slider">SFX VOLUME</label>
							<input type="range" id="sfx-slider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="about-modal" class="modal" style="display: none;">
			<div class="modal-content">
				<span class="close-btn">&times;</span>
				<div class="book-wrapper">
					<!-- Static background image -->
					<img id="book-bg" src="images/about_screenshot.png" alt="About Game">
					
					<!-- Flip animation GIF (hidden by default) -->
					<img id="book-flip-anim" src="images/book_flip.gif" alt="Flipping..." style="display: none;">

					<div class="book-text" id="book-content-1">
						<div class="page left-page">
							<p>Hi, we're a young indie game team from Vietnam! I wish I could say that, but currently I'm just a solo developer creating small products out of passion and looking for future opportunities and teammates for the studio.</p>
						</div>
						<div class="page right-page">
							<p>We hope you have a good experience with our studio's products. You can support the studio with the donation link below; the amount doesn't matter, but 40% of the project will go to the SOS Children's Village in Vietnam.</p>
							<button class="nav-btn next-btn">NEXT &gt;</button>
						</div>
					</div>

					<div class="book-text" id="book-content-2" style="display: none;">
						<div class="page left-page">
							<p>The remaining 60% will be invested in the studio's next project.</p>
							<p>Donate: <a href="https://buymeacoffee.com/IdoSleepStudio" target="_blank">buymeacoffee.com/IdoSleepStudio</a></p>
							<p>Contact if you are interested:<br>
							Email: <a href="mailto:kirvu05@gmail.com">kirvu05@gmail.com</a><br>
							Threads: <a href="https://www.threads.net/@kirvu_05" target="_blank">kirvu_05</a></p>
						</div>
						<div class="page right-page">
							<p>I Do Sleep Studio,<br>
							We sleep less so you can play more :3</p>
							<p style="font-size: 0.8em; margin-top: 10px;">P/S: Some resources in Decipher Dash are taken from Pinterest and I can't found its credits though trying. If you are one of the artists who own these resources, please contact me to receive royalties.</p>
							<button class="nav-btn prev-btn">&lt; PREV</button>
						</div>
					</div>
				</div>
			</div>
		</div>

    <script>
		// Generate stars dynamically
		(function() {
			const menu = document.getElementById('game-menu');
			for (let i = 0; i < 150; i++) {
				const star = document.createElement('div');
				star.className = 'star';
				const size = Math.random() * 2 + 1 + 'px'; // 1px to 3px
				star.style.width = size;
				star.style.height = size;
				star.style.left = Math.random() * 100 + '%';
				star.style.top = Math.random() * 100 + '%';
				star.style.animationDuration = (Math.random() * 3 + 1) + 's'; // 1s to 4s
				star.style.animationDelay = (Math.random() * 3) + 's';
				menu.appendChild(star);
			}
		})();

		// Menu Music Logic
		const menuMusic = document.getElementById('menu-music');
		const level1Music = document.getElementById('level1-music');
		const introSound = document.getElementById('intro-sound');
		const clickSound = document.getElementById('click-sound');
		const pixelDeathSound = document.getElementById('pixel-death-sound');
		const gameOverSound = document.getElementById('game-over-sound');
		menuMusic.volume = 0.5; // Default volume
		
		// Global Volume Variables
		window.sfxVolume = 0.5;

		// Global functions for Game Logic (to be called from C3 or detected)
		window.playerLives = 3;
		window.gemCount = 0;
		window.gemTarget = 10;
		window.updateGemCounter = function() {
			const el = document.getElementById('gem-counter');
			if (el) el.innerText = String(window.gemCount) + "/" + String(window.gemTarget);
		};
		window.stopGameMusic = function() {
			try {
				if (menuMusic) { menuMusic.pause(); menuMusic.currentTime = 0; menuMusic.loop = false; }
				if (level1Music) { level1Music.pause(); level1Music.currentTime = 0; level1Music.loop = false; }
			} catch (e) {}
		};
		window.stopAudioForWin = function() {
			try {
				[menuMusic, level1Music, introSound, clickSound, pixelDeathSound, gameOverSound, document.getElementById('get-coin-sound')]
					.forEach(a => {
						try {
							if (a) {
								a.pause();
								a.currentTime = 0;
								a.loop = false;
							}
						} catch (e) {}
					});
			} catch (e) {}
		};

		window.onPlayerDeath = function() {
			if (window.isYouWinProcessing) return;
			console.log("Player Death Triggered");
			if (pixelDeathSound) {
				pixelDeathSound.currentTime = 0;
				pixelDeathSound.volume = window.sfxVolume;
				pixelDeathSound.play().catch(e => console.log("Pixel death play failed:", e));
			}
			if (level1Music) {
				level1Music.pause();
				level1Music.currentTime = 0;
			}
			
			// Decrease Lives Logic
			// Note: We process Game Over screen even if lives are already 0, 
			// in case the screen was closed or needs to be refreshed.
			if (window.playerLives > 0) {
				// Prevent double damage in short timeframe
				if (window.isTakingDamage) return;
				window.isTakingDamage = true;
				setTimeout(() => { window.isTakingDamage = false; }, 500);

				const heart = document.getElementById('heart-' + window.playerLives);
				if (heart) {
					heart.style.visibility = 'hidden'; // Hide the heart
				}
				window.playerLives--;
				console.log("Lives remaining: " + window.playerLives);
			}

			if (window.playerLives <= 0) {
				console.log("Game Over Logic Triggered");
				
				if (window.isGameOverProcessing) {
					console.log("Game Over already processing, skipping duplicate call.");
					return;
				}
				window.isGameOverProcessing = true;
				
				// Show Game Over screen
				const gameOverScreen = document.getElementById('game-over-screen');
				const countdownEl = document.getElementById('game-over-countdown');
				const backBtn = document.getElementById('game-over-back-btn');
				
				if (gameOverScreen) {
					gameOverScreen.style.display = 'flex';
					console.log("Game Over Screen Displayed (Flex)");
					
					// Force reset elements
					if (countdownEl) {
						countdownEl.style.display = 'none';
						countdownEl.innerText = '';
					}
					if (backBtn) {
						backBtn.style.display = 'none';
					}
					
					// Play Game Over Sound
					if (gameOverSound) {
						gameOverSound.currentTime = 0;
						gameOverSound.volume = window.sfxVolume;
						gameOverSound.play().catch(e => console.log("Game over sound failed:", e));
					}
					
					// Ensure music is off
					if (level1Music) {
						level1Music.pause();
						level1Music.currentTime = 0;
					}
					
					// Countdown Logic
					console.log("Setting timeout for countdown...");
					setTimeout(() => {
						if (countdownEl) {
							console.log("Starting Countdown Sequence");
							countdownEl.style.display = 'block';
							let count = 3;
							countdownEl.innerText = count;
							
							const interval = setInterval(() => {
								count--;
								if (count > 0) {
									countdownEl.innerText = count;
								} else {
									clearInterval(interval);
									countdownEl.style.display = 'none'; // Hide countdown
									
									if (backBtn) {
										backBtn.style.display = 'block'; // Show button
										
										// Clone button to remove old listeners
										const newBtn = backBtn.cloneNode(true);
										backBtn.parentNode.replaceChild(newBtn, backBtn);
										
										newBtn.addEventListener('click', (e) => {
											e.stopPropagation();
											console.log("Back to Menu Clicked");
											
											// Play click sound
											if (clickSound) {
												clickSound.currentTime = 0;
												clickSound.volume = window.sfxVolume;
												clickSound.play().catch(e => console.log("Click sound failed:", e));
											}
											
											// Delay 1000ms then reload
											setTimeout(() => {
												location.reload();
											}, 1000);
										});
									}
								}
							}, 1000);
						} else {
							console.error("Countdown Element Missing inside Timeout!");
						}
					}, 2000);
				} else {
					console.error("Game Over Screen Element Missing!");
				}
			}
		};

		window.onLevelRestart = function() {
			console.log("Level Restart Triggered");
			
			// If lives are 0 or game is won, do NOT restart the level music
			if (window.playerLives <= 0 || window.isGameWon) return;

			// Note: We do NOT reset lives here, because restart happens on death.
			// Only reset lives if it's a "Game Over" restart or manual restart from menu.
			
			if (level1Music) {
				level1Music.volume = menuMusic.volume;
				level1Music.play().catch(e => console.log("Level 1 music play failed:", e));
			}
		};
		
		// Function to reset game state (lives)
		window.resetGame = function() {
			window.isGameWon = false; // Reset win flag
			window.playerLives = 3;
			for (let i = 1; i <= 3; i++) {
				const heart = document.getElementById('heart-' + i);
				if (heart) heart.style.visibility = 'visible';
			}
			window.gemCount = 0;
			window.updateGemCounter();
			console.log("Game Reset: Lives restored");
		};

		// Attempt to play music on load
		function playMusic() {
			menuMusic.play().catch(e => {
				console.log("Autoplay prevented:", e);
				// Add one-time listener to start music on first interaction
				document.addEventListener('click', function startMusic() {
					menuMusic.play();
					document.removeEventListener('click', startMusic);
				}, { once: true });
			});
		}
		playMusic();

        // Preload game resources but don't start
        let gameStarted = false;

		document.getElementById('play-btn').addEventListener('click', function(e) {
			e.stopPropagation(); // Prevent bubbling if necessary
			
			// Play click sound
			if (clickSound) {
				clickSound.currentTime = 0;
				clickSound.volume = sfxVolume;
				clickSound.play().catch(e => console.log("Click sound failed:", e));
			}
			
			// Stop menu music
			menuMusic.pause();
			menuMusic.currentTime = 0;

			// Reset game lives
			window.resetGame();

			// Play Intro Sound immediately
			introSound.volume = sfxVolume;
			introSound.play().catch(e => console.log("Intro sound play failed:", e));

			// Play Level 1 Music with 3s delay
			setTimeout(() => {
				introSound.pause(); // Stop Intro Sound
				introSound.currentTime = 0;
				
				level1Music.volume = menuMusic.volume;
				level1Music.play().catch(e => console.log("Level 1 music play failed:", e));
			}, 3000);

			// Attempt to enter fullscreen
			try {
				var elem = document.documentElement;
				if (elem.requestFullscreen) {
					elem.requestFullscreen();
				} else if (elem.webkitRequestFullscreen) { /* Safari */
					elem.webkitRequestFullscreen();
				} else if (elem.msRequestFullscreen) { /* IE11 */
					elem.msRequestFullscreen();
				}
			} catch (err) {
				console.log("Error attempting to enable fullscreen:", err);
			}

            if (gameStarted) return;
            gameStarted = true;
            
			// Hide buttons
			document.getElementById('play-btn').style.display = 'none';
			document.getElementById('about-btn').style.display = 'none';
			document.getElementById('setting-btn').style.display = 'none';
			
			// Show loading screen
			document.getElementById('loading-screen').style.display = 'flex';

            const skipContainer = document.getElementById('skip-container');
            let skipKeyHandler = null;
            function showUIWhenGameReady() {
                const ingameSettingIcon = document.getElementById('ingame-setting-icon');
                const playerHearts = document.getElementById('player-hearts');
                const loading = document.getElementById('loading-screen');
                const menuEl = document.getElementById('game-menu');
                const spaceshipEl = document.getElementById('spaceship-screen');
                function checkReady() {
                    const canvas = document.querySelector('canvas');
                    const canvasReady = !!canvas && canvas.clientWidth > 0 && canvas.clientHeight > 0 && window.getComputedStyle(canvas).visibility !== 'hidden' && window.getComputedStyle(canvas).display !== 'none';
                    const menuHidden = !!menuEl && window.getComputedStyle(menuEl).display === 'none';
                    const spaceshipHidden = !!spaceshipEl && window.getComputedStyle(spaceshipEl).display === 'none';
                    if (canvasReady && menuHidden && spaceshipHidden) {
                        if (loading) loading.style.display = 'none';
                        if (ingameSettingIcon) ingameSettingIcon.style.display = 'block';
                        if (playerHearts) playerHearts.style.display = 'flex';
                        const gemCounter = document.getElementById('gem-counter');
                        if (gemCounter) gemCounter.style.display = 'block';
                        window.updateGemCounter();
                        return true;
                    }
                    return false;
                }
                if (!checkReady()) {
                    const iv = setInterval(() => {
                        if (checkReady()) clearInterval(iv);
                    }, 100);
                    setTimeout(() => { clearInterval(iv); }, 15000);
                }
            }
            const finishIntro = () => {
                const menu = document.getElementById('game-menu');
                const spaceshipScreenEl = document.getElementById('spaceship-screen');
                const outroVideoEl = document.getElementById('outro-video');
                menu.style.transition = 'opacity 0.5s ease';
                menu.style.opacity = '0';
                setTimeout(() => {
                    menu.style.display = 'none';
                    if (spaceshipScreenEl) spaceshipScreenEl.style.display = 'none';
                    if (outroVideoEl) outroVideoEl.pause();
                    if (skipContainer) skipContainer.style.display = 'none';
                    if (skipKeyHandler) window.removeEventListener('keydown', skipKeyHandler);
                }, 500);
                if (window.startC3Game) {
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            window.startC3Game();
                            showUIWhenGameReady();
                            const canvas = document.querySelector('canvas');
                            if (canvas) { canvas.tabIndex = 0; canvas.focus(); }
                        }, 50);
                    });
                } else {
                    var checkInterval = setInterval(function() {
                        if (window.startC3Game) {
                            window.startC3Game();
                            showUIWhenGameReady();
                            const canvas = document.querySelector('canvas');
                            if (canvas) { canvas.tabIndex = 0; canvas.focus(); }
                            clearInterval(checkInterval);
                        }
                    }, 100);
                }
            };
            if (skipContainer) {
                skipContainer.style.display = 'flex';
                skipContainer.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    finishIntro();
                });
                skipKeyHandler = function(ev) {
                    const k = (ev.key || '').toLowerCase();
                    if (k === 's') {
                        ev.preventDefault();
                        finishIntro();
                    }
                };
                window.addEventListener('keydown', skipKeyHandler);
            }

			// Wait 6 seconds then fade out
			setTimeout(() => {
				// Hide loading screen
				document.getElementById('loading-screen').style.display = 'none';

				// Show spaceship screen
				const spaceshipScreen = document.getElementById('spaceship-screen');
				spaceshipScreen.style.display = 'flex';
				const outroVideo = document.getElementById('outro-video');

				const finishIntro = () => {
					const menu = document.getElementById('game-menu');
					menu.style.transition = 'opacity 0.5s ease';
					menu.style.opacity = '0';
					
					setTimeout(() => {
						menu.style.display = 'none';
						spaceshipScreen.style.display = 'none';
						if(outroVideo) outroVideo.pause();
                        if (skipContainer) skipContainer.style.display = 'none';
                        if (skipKeyHandler) window.removeEventListener('keydown', skipKeyHandler);
						
						// Show in-game setting icon
						const ingameSettingIcon = document.getElementById('ingame-setting-icon');
						if (ingameSettingIcon) {
							// ingameSettingIcon.style.display = 'block'; // Removed immediate show
							console.log("In-game setting icon ready");
						}

						// Show player hearts
						const playerHearts = document.getElementById('player-hearts');
						if (playerHearts) {
							// playerHearts.style.display = 'flex'; // Removed immediate show
							console.log("Player hearts ready");
						}
					}, 500);

					if (window.startC3Game) {
						requestAnimationFrame(() => {
							setTimeout(() => {
                                window.startC3Game();
                                showUIWhenGameReady();
                            }, 50);
						});
					} else {
						console.log("Game engine not loaded yet, waiting...");
						var checkInterval = setInterval(function() {
							if (window.startC3Game) {
								window.startC3Game();
                                showUIWhenGameReady();

								clearInterval(checkInterval);
							}
						}, 100);
					}
				};

				if (outroVideo) {
					outroVideo.currentTime = 0;
					outroVideo.onended = finishIntro;
					outroVideo.play().catch(e => {
						console.log("Video play failed:", e);
						setTimeout(finishIntro, 4000);
					});
				} else {
					setTimeout(finishIntro, 4000);
				}
			}, 6000); // 6 seconds loading delay
        });
		
		// In-Game Setting Icon Logic
		const ingameSettingIcon = document.getElementById('ingame-setting-icon');
		
		const menu = document.getElementById('game-menu');
		// Fallback MutationObserver removed to avoid showing UI too early

		ingameSettingIcon.addEventListener('click', function(e) {
			e.stopPropagation();
			// Open setting modal
			settingModal.style.display = 'flex';
			ingameSettingIcon.style.display = 'none'; // Hide icon when modal is open
			
			// Play click sound
			if (clickSound) {
				clickSound.currentTime = 0;
				clickSound.volume = sfxVolume;
				clickSound.play().catch(e => {});
			}
		});

		// About Modal Logic
		const aboutBtn = document.getElementById('about-btn');
		const aboutModal = document.getElementById('about-modal');
		// Use specific selector for about close button to avoid conflict
		const closeBtn = aboutModal.querySelector('.close-btn');

		aboutBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			aboutModal.style.display = 'flex';
		});

		closeBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			aboutModal.style.display = 'none';
		});

		window.addEventListener('click', function(e) {
			if (e.target == aboutModal) {
				aboutModal.style.display = 'none';
			}
			if (e.target == settingModal) {
				settingModal.style.display = 'none';
			}
		});

		// Setting Modal Logic
		const settingBtn = document.getElementById('setting-btn');
		const settingModal = document.getElementById('setting-modal');
		const settingCloseBtn = document.querySelector('.setting-close');
		const volumeSlider = document.getElementById('volume-slider');

		settingBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			settingModal.style.display = 'flex';
		});

		settingCloseBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			settingModal.style.display = 'none';
			
			// If game is running (menu hidden), show the ingame icon again
			if (menu.style.display === 'none') {
				ingameSettingIcon.style.display = 'block';
			}
		});

		volumeSlider.addEventListener('input', function(e) {
			menuMusic.volume = e.target.value;
			if (level1Music) level1Music.volume = e.target.value;
		});

		// Button Click Sound Logic
		const menuButtons = [
			document.getElementById('about-btn'),
			document.getElementById('setting-btn'),
			document.querySelector('.next-btn'),
			document.querySelector('.prev-btn'),
			document.querySelector('.setting-close'),
			aboutModal.querySelector('.close-btn')
		];
		
		// SFX Volume Control
		const sfxSlider = document.getElementById('sfx-slider');
		let sfxVolume = 0.5;

		if (clickSound) clickSound.volume = sfxVolume;
		if (introSound) introSound.volume = sfxVolume; // Intro sound is also SFX
		if (pixelDeathSound) pixelDeathSound.volume = sfxVolume;
		if (gameOverSound) gameOverSound.volume = sfxVolume;
		const getCoinSound = document.getElementById('get-coin-sound');
		if (getCoinSound) getCoinSound.volume = sfxVolume;
		const levelPassedSound = document.getElementById('level-passed-sound');
		if (levelPassedSound) levelPassedSound.volume = sfxVolume;

		sfxSlider.addEventListener('input', function(e) {
			sfxVolume = e.target.value;
			if (clickSound) clickSound.volume = sfxVolume;
			if (introSound) introSound.volume = sfxVolume;
			if (pixelDeathSound) pixelDeathSound.volume = sfxVolume;
			if (gameOverSound) gameOverSound.volume = sfxVolume;
			if (getCoinSound) getCoinSound.volume = sfxVolume;
			if (levelPassedSound) levelPassedSound.volume = sfxVolume;
		});

		// Global function to play get coin sound (to be called by hooks)
		window.onRewardPickup = function() {
			// If game is already won, do NOT play sound or process gem logic
			if (window.isGameWon || window.isYouWinProcessing) return;
			
			try {
				if (getCoinSound) {
					getCoinSound.currentTime = 0;
					getCoinSound.play().catch(() => {});
				}
				window.gemCount = Math.min((window.gemCount || 0) + 1, window.gemTarget);
				window.updateGemCounter();
				if (window.gemCount >= window.gemTarget) {
					if (!window.isYouWinProcessing) {
						window.isYouWinProcessing = true;
						var __win_called = false;
						var __call_win = function() {
							if (!__win_called) {
								__win_called = true;
								if (typeof window.onYouWin === 'function') window.onYouWin();
							}
						};
						if (getCoinSound && !getCoinSound.paused) {
							// Use a fixed short delay (e.g. 500ms) to show Win screen faster, 
							// while still allowing some of the coin sound to play.
							setTimeout(__call_win, 500);
						} else {
							__call_win();
						}
					}
				}
			} catch (err) {
				console.log("Play get-coin failed:", err);
			}
		};
		
		window.onYouWin = function() {
			window.isGameWon = true; // Set flag to prevent restart logic
			const youWinScreen = document.getElementById('you-win-screen');
			const backBtn = document.getElementById('you-win-back-btn');
			const winScoreText = document.getElementById('win-score-text');
			
			// Initial text before animation
			if (winScoreText) {
				winScoreText.innerText = "Your Highest Scores: 0";
			}

			if (youWinScreen) {
				// Explicitly stop level 1 music by ID to ensure it stops
				const l1Music = document.getElementById('level1-music');
				if (l1Music) {
					l1Music.loop = false;
					l1Music.volume = 0;
					l1Music.pause();
					l1Music.currentTime = 0;
				}
				window.stopGameMusic();
				window.stopAudioForWin();
				youWinScreen.style.display = 'flex';
				const ingameSettingIcon = document.getElementById('ingame-setting-icon');
				const playerHearts = document.getElementById('player-hearts');
				const gemCounter = document.getElementById('gem-counter');
				if (ingameSettingIcon) ingameSettingIcon.style.display = 'none';
				if (playerHearts) playerHearts.style.display = 'none';
				if (gemCounter) gemCounter.style.display = 'none';
				try {
					const levelPassed = document.getElementById('level-passed-sound');
					if (levelPassed) {
						levelPassed.currentTime = 0;
						levelPassed.muted = false;
						levelPassed.volume = window.sfxVolume ?? 0.5;
						levelPassed.load();
						setTimeout(() => {
							levelPassed.play().catch(()=>{});
							
							// Start Score Animation after Level Passed sound starts
							if (winScoreText) {
								let currentScore = 0;
								const targetScore = window.gemCount || 0;
								const duration = 1500; // Animation duration in ms
								const stepTime = Math.max(50, duration / (targetScore || 1));
								
								if (targetScore > 0) {
									setTimeout(() => {
										const scoreInterval = setInterval(() => {
											currentScore++;
											winScoreText.innerText = "Your Highest Scores: " + currentScore;
											
											// Play click sound for each increment
											if (clickSound) {
												try {
													// Clone node to allow overlapping sounds (rapid fire)
													const clickClone = clickSound.cloneNode();
													clickClone.volume = window.sfxVolume ?? 0.5;
													// Use a promise-based play with error handling
													var playPromise = clickClone.play();
													if (playPromise !== undefined) {
														playPromise.catch(error => {
															// Fallback: try playing the main clickSound if clone fails
															// (though main sound might be cut off, it's better than silence)
															console.log("Clone play failed, trying main:", error);
															clickSound.currentTime = 0;
															clickSound.play().catch(e => {});
														});
													}
												} catch (e) {
													// Final fallback
													clickSound.currentTime = 0;
													clickSound.play().catch(()=>{});
												}
											}

											if (currentScore >= targetScore) {
												clearInterval(scoreInterval);
											}
										}, stepTime);
									}, 500); // Wait 0.5s after Win screen appears
								}
							}
						}, 50);
					}
				} catch (e) {}
				try {
					// Suspend Construct 3 runtime
					if (window.c3_runtimeInterface) {
						window.c3_runtimeInterface._GetLocalRuntime().SetTimeScale(0);
					} else if (window.__c3_runtime) {
						window.__c3_runtime.timeScale = 0;
						window.__c3_runtime.SetTimeScale(0);
					}
					// Also try to pause the main loop if accessible
					if (window.c3_runtime) {
						window.c3_runtime.SetTimeScale(0);
					}
				} catch (e) {
					console.log("Error stopping game runtime:", e);
				}
				if (backBtn) {
					// Remove old listeners
					const newBtn = backBtn.cloneNode(true);
					backBtn.parentNode.replaceChild(newBtn, backBtn);
					newBtn.addEventListener('click', (e) => {
						e.stopPropagation();
						setTimeout(() => {
							location.reload();
						}, 800);
					});
				}
			}
		};

		menuButtons.forEach(btn => {
			if (btn) {
				btn.addEventListener('click', () => {
					if (clickSound) {
						clickSound.currentTime = 0;
						clickSound.volume = sfxVolume;
						clickSound.play().catch(e => {
							// Ignore autoplay restrictions
						});
					}
				});
			}
		});

		// Book Flip Logic
		const nextBtn = document.querySelector('.next-btn');
		const prevBtn = document.querySelector('.prev-btn');
		const bookContent1 = document.getElementById('book-content-1');
		const bookContent2 = document.getElementById('book-content-2');
		const bookBg = document.getElementById('book-bg');
		const bookFlipAnim = document.getElementById('book-flip-anim');

		function playFlipAnim(callback) {
			// Hide static BG and current content
			bookBg.style.display = 'none';
			bookContent1.style.display = 'none';
			bookContent2.style.display = 'none';
			
			// Show animation
			bookFlipAnim.style.display = 'block';
			// Reset GIF to play from start
			const src = bookFlipAnim.src;
			bookFlipAnim.src = '';
			bookFlipAnim.src = src;

			// Wait for animation (adjust time based on GIF duration, e.g., 1200ms)
			setTimeout(() => {
				bookFlipAnim.style.display = 'none';
				bookBg.style.display = 'block';
				if (callback) callback();
			}, 1200);
		}

		nextBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			playFlipAnim(() => {
				bookContent2.style.display = 'flex';
			});
		});

		prevBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			playFlipAnim(() => {
				bookContent1.style.display = 'flex';
			});
		});
    </script>

	

<script>
if (location.protocol.substr(0, 4) === "file")
{
	alert("Web exports won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)");
}
</script>
	
	<noscript>
		<div id="notSupportedWrap">
			<h2 id="notSupportedTitle">This content requires JavaScript</h2>
			<p class="notSupportedMessage">JavaScript appears to be disabled. Please enable it to view this content.</p>
		</div>
	</noscript>
	<script src="scripts/modernjscheck.js"></script>
	<script src="scripts/supportcheck.js"></script>
	<script src="scripts/offlineclient.js" type="module"></script>
	<script src="scripts/custom-hook.js"></script>
	<script src="scripts/main.js?v=3" type="module"></script>
	<script src="scripts/register-sw.js" type="module"></script>

</body> 
</html>
